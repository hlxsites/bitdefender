name: Testing

env:
  BRANCH_NAME: ${{ github.head_ref || github.ref_name }}
  BASE_URL: '--bitdefender--hlxsites.hlx.page/sidekick/blocks/'

on:
  pull_request:
    branches:
      - "main"

jobs:
  linting:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Use node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'
    - run: npm install
    - run: npm run lint
      env:
        CI: true

  identify_blocks:
    runs-on: ubuntu-latest
    needs: linting
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - name: Get list of changed blocks
      id: identify-blocks
      run: |
        changed_blocks=""
        changed_files=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
        echo "Changed files: $changed_files"
        for file in $changed_files; do
          if [[ $file == blocks/* ]]; then
            block_name=$(echo $file | cut -d'/' -f2)
            echo "Changed block: $block_name"
            changed_blocks="$changed_blocks $block_name"
          fi
        done
        echo "CHANGED_BLOCKS=$changed_blocks" >> $GITHUB_ENV

  ghost_inspector_tests:
    needs: identify_blocks
    runs-on: ubuntu-latest
    steps:
    - name: Setup Block Tests
      run: |
        for block in $CHANGED_BLOCKS; do
          echo "Running Ghost Inspector test for block: $block"
          # Fetch the test ID for the current block. Assuming secrets are named like "GI_TEST_ID_<BLOCK_NAME>"
          test_id_var="GI_TEST_ID_${block^^}"
          test_id=${!test_id_var}

          # Check if test_id is empty and fail the workflow if so
          if [ -z "$test_id" ]; then
            echo "Error: Test ID for block $block is missing!"
            xit 1
          fi

          block_url="https://${{ env.BRANCH_NAME }}${{ env.BASE_URL }}$block"
          docker run ghostinspector/cli suite execute $test_id \
              --apiKey ${{ secrets.GI_API_KEY }} \
              --startUrl $block_url \
              --errorOnFail \
              --errorOnScreenshotFail
        done
      env:
        CHANGED_BLOCKS: ${{ env.CHANGED_BLOCKS }}


